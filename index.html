<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Assistant</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
        }
        
        .logo {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin-bottom: 4px;
            color: #64748b;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background: #f1f5f9;
            color: #3b82f6;
        }
        
        .nav-item.active {
            background: #f0f9ff;
            color: #3b82f6;
        }
        
        .panel-container {
            width: 400px;
            background: white;
            border-right: 1px solid #e2e8f0;
        }
        
        .panel {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        
        .panel.active {
            display: flex;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .writing-area {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .writing-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .writing-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            border: none;
            outline: none;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .writing-meta {
            color: #64748b;
            font-size: 14px;
        }
        
        .writing-content {
            flex: 1;
            padding: 20px;
        }
        
        .editor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            color: #334155;
            resize: none;
            font-family: Georgia, 'Times New Roman', serif;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            margin-bottom: 20px;
        }
        
        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .btn:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .empty-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .empty-description {
            font-size: 14px;
        }
        
        .file-drop-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-drop-area:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .file-drop-area.dragover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .source-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .source-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .source-icon {
            width: 32px;
            height: 32px;
            background: #f1f5f9;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .source-info {
            flex: 1;
        }

        .source-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .source-author {
            font-size: 12px;
            color: #64748b;
        }

        .status-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.processing {
            background: #fbbf24;
        }

        .status-badge.error {
            background: #ef4444;
        }

        .source-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .source-action-btn {
            flex: 1;
            background: none;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .source-action-btn:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .source-action-btn.delete {
            color: #ef4444;
            border-color: #fecaca;
        }

        .source-action-btn.delete:hover {
            background: #fef2f2;
            border-color: #ef4444;
        }

        /* New styles for notes */
        .note-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .note-card:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .note-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .note-relevance {
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .note-source {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .note-content {
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
            margin-bottom: 8px;
        }

        .note-path {
            font-size: 11px;
            color: #9ca3af;
            font-style: italic;
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px;
            color: #64748b;
            font-size: 14px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .context-indicator {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 16px;
            display: none;
        }

        .context-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">Research Assistant</div>
        
        <div class="nav-item active" onclick="switchToPanel('projects', this)">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Projects
        </div>
        <div class="nav-item" onclick="switchToPanel('library', this)">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Library
        </div>
        <div class="nav-item" onclick="switchToPanel('notes', this)">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Notes
        </div>
    </div>
    
    <div class="panel-container">
        <!-- Projects Panel -->
        <div class="panel active" id="projects-panel">
            <div class="panel-header">
                <div class="panel-title">Projects</div>
            </div>
            <div class="panel-content">
                <input type="text" class="search-input" placeholder="Search projects..." id="project-search">
                <button class="btn" onclick="alert('Create new project')">+ New Project</button>
                
                <div style="margin-top: 20px;">
                    <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 4px;">Grace and Sovereignty: A Reformed Perspective</div>
                        <div style="font-size: 12px; color: #64748b;">2,847 words ‚Ä¢ Draft</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Library Panel -->
        <div class="panel" id="library-panel">
            <div class="panel-header">
                <div class="panel-title">Library</div>
            </div>
            <div class="panel-content">
                <input type="text" class="search-input" placeholder="Search sources..." id="library-search">
                <button class="btn" onclick="showUploadInterface()">+ Upload Source</button>
                
                <!-- Upload Form -->
                <div id="upload-form" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc;">
                    <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600; color: #1e293b;">Upload New Source</h3>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Title</label>
                        <input type="text" id="upload-title" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Author (optional)</label>
                        <input type="text" id="upload-author" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Choose File</label>
                        <div class="file-drop-area" onclick="document.getElementById('file-input').click()">
                            <input type="file" id="file-input" accept=".txt,.json,.pdf" style="display: none;">
                            <svg width="48" height="48" style="margin: 0 auto 12px; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <div style="font-size: 14px; color: #374151; margin-bottom: 4px;">
                                <strong>Click to upload</strong> or drag and drop
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                Supports: .txt, .json, .pdf files
                            </div>
                        </div>
                        <div id="selected-file" style="display: none; margin-top: 12px; padding: 8px; background: #f0f9ff; border-radius: 4px; font-size: 14px; color: #1e40af;"></div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="processUpload()" id="upload-btn" disabled>Upload & Process</button>
                        <button onclick="hideUploadInterface()" style="background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer;">Cancel</button>
                    </div>
                    
                    <div id="upload-status" style="margin-top: 12px; font-size: 14px;"></div>
                </div>
                
                <div style="margin-top: 20px;" id="sources-list">
                    <div class="empty-state">
                        <div class="empty-icon">üìö</div>
                        <div class="empty-title">No sources yet</div>
                        <div class="empty-description">Upload your first source to get started</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notes Panel -->
        <div class="panel" id="notes-panel">
            <div class="panel-header">
                <div class="panel-title">Related Notes</div>
            </div>
            <div class="panel-content">
                <div class="context-indicator" id="context-indicator">
                    No context selected. Click in your document to see related notes.
                </div>
                
                <div id="notes-loading" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    Finding related content...
                </div>
                
                <div style="margin-top: 20px;" id="notes-list">
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-title">No notes yet</div>
                        <div class="empty-description">Position your cursor in the document to see related notes</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Writing Area -->
    <div class="writing-area">
        <div class="writing-header">
            <input type="text" class="writing-title" placeholder="Untitled Document" value="Grace and Sovereignty: A Reformed Perspective" id="document-title">
            <div class="writing-meta">Draft ‚Ä¢ Last modified: Today</div>
        </div>
        <div class="writing-content">
            <textarea class="editor" placeholder="Start writing your research paper..." id="document-editor">The concept of grace in Christian theology has been debated for centuries. Calvin's understanding differs significantly from the Catholic interpretation, particularly in his emphasis on unmerited favor and divine sovereignty.

This fundamental doctrine shapes how we approach both salvation and sanctification. The reformers argued that grace cannot be earned through works, but is freely given by God to the elect.

In examining this more closely, we must consider how grace operates in the life of the believer. Calvin taught that grace is not merely God's attitude toward us, but His active power working within us to transform our hearts and minds according to His will.</textarea>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let selectedFile = null;
        let searchTimeout = null;
        let lastSearchContext = '';
        
        // Panel switching function
        function switchToPanel(panelName, element) {
            console.log('Switching to panel:', panelName);
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update panel visibility
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            const targetPanel = document.getElementById(panelName + '-panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Successfully switched to:', panelName);
            } else {
                console.error('Panel not found:', panelName + '-panel');
            }
            
            // Load sources when switching to library
            if (panelName === 'library') {
                console.log('Loading library sources...');
                loadSourcesFromBackend();
            }
        }
        
        // Auto-generate notes based on cursor context
        function updateNotesBasedOnContext() {
            const editor = document.getElementById('document-editor');
            const cursorPosition = editor.selectionStart;
            const text = editor.value;
            
            // Get context around cursor (previous and next 100 characters)
            const contextStart = Math.max(0, cursorPosition - 100);
            const contextEnd = Math.min(text.length, cursorPosition + 100);
            const context = text.substring(contextStart, contextEnd).trim();
            
            // Skip if context is too short or hasn't changed significantly
            if (context.length < 20 || context === lastSearchContext) {
                return;
            }
            
            lastSearchContext = context;
            
            // Update context indicator
            const contextIndicator = document.getElementById('context-indicator');
            contextIndicator.textContent = `Searching for: "${context.substring(0, 50)}${context.length > 50 ? '...' : ''}"`;
            contextIndicator.classList.add('active');
            
            // Show loading state
            const loadingDiv = document.getElementById('notes-loading');
            const notesList = document.getElementById('notes-list');
            loadingDiv.style.display = 'flex';
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Debounce the search
            searchTimeout = setTimeout(() => {
                searchRelatedNotes(context);
            }, 500);
        }
        
        async function searchRelatedNotes(query) {
            try {
                const response = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }
                
                const results = await response.json();
                displayRelatedNotes(results);
                
            } catch (error) {
                console.error('Search error:', error);
                displayNoNotes('Search failed. Is your backend running?');
            } finally {
                document.getElementById('notes-loading').style.display = 'none';
            }
        }
        
        function displayRelatedNotes(results) {
            const notesList = document.getElementById('notes-list');
            
            if (results.length === 0) {
                displayNoNotes('No related content found for the current context.');
                return;
            }
            
            notesList.innerHTML = '';
            
            results.forEach((result, index) => {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                
                // Calculate relevance percentage
                const relevancePercent = Math.round(result.score * 100);
                
                noteCard.innerHTML = `
                    <div class="note-header">
                        <div class="note-relevance">${relevancePercent}%</div>
                        <div class="note-source">${result.source_title}</div>
                    </div>
                    <div class="note-content">${result.content}</div>
                    <div class="note-path">${result.structure_path}</div>
                `;
                
                notesList.appendChild(noteCard);
            });
        }
        
        function displayNoNotes(message) {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-title">No related notes</div>
                    <div class="empty-description">${message}</div>
                </div>
            `;
        }
        
        function showUploadInterface() {
            console.log('Showing upload interface');
            document.getElementById('upload-form').style.display = 'block';
        }
        
        function hideUploadInterface() {
            document.getElementById('upload-form').style.display = 'none';
            document.getElementById('upload-title').value = '';
            document.getElementById('upload-author').value = '';
            document.getElementById('upload-status').innerHTML = '';
            document.getElementById('selected-file').style.display = 'none';
            document.getElementById('upload-btn').disabled = true;
            selectedFile = null;
        }
        
        function handleFileSelection(file) {
            if (!file) return;
            
            selectedFile = file;
            
            // Show selected file info
            const fileInfo = document.getElementById('selected-file');
            fileInfo.innerHTML = `
                <strong>Selected:</strong> ${file.name} 
                <span style="color: #6b7280;">(${(file.size / 1024).toFixed(1)} KB)</span>
            `;
            fileInfo.style.display = 'block';
            
            // Auto-fill title if empty
            const titleInput = document.getElementById('upload-title');
            if (!titleInput.value) {
                const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                titleInput.value = fileName;
            }
            
            // Enable upload button
            document.getElementById('upload-btn').disabled = false;
        }
        
        async function processUpload() {
            const title = document.getElementById('upload-title').value.trim();
            const author = document.getElementById('upload-author').value.trim();
            const statusDiv = document.getElementById('upload-status');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (!title) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">Please enter a title</span>';
                return;
            }
            
            if (!selectedFile) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">Please select a file</span>';
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            statusDiv.innerHTML = '<span style="color: #3b82f6;">Starting upload...</span>';
            
            try {
                const content = await readFileContent(selectedFile);
                
                const fileName = selectedFile.name.toLowerCase();
                let sourceType = 'txt';
                if (fileName.endsWith('.json')) {
                    sourceType = 'json';
                } else if (fileName.endsWith('.pdf')) {
                    sourceType = 'pdf';
                }
                
                const tempId = 'temp-' + Date.now();
                
                addSourceToUI({
                    id: tempId,
                    title: title,
                    author: author || 'Unknown Author',
                    source_type: sourceType,
                    status: 'processing'
                });
                
                hideUploadInterface();
                
                const response = await fetch(`${API_BASE}/upload-source`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        author: author || 'Unknown Author',
                        source_type: sourceType,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Upload successful:', result);
                
                updateSourceStatus(tempId, {
                    id: result.source_id,
                    chunks_created: result.chunks_created,
                    status: 'completed'
                });
                
            } catch (error) {
                console.error('Upload error:', error);
                updateSourceStatus(tempId, {
                    status: 'error',
                    error: error.message
                });
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload & Process';
            }
        }
        
        async function deleteSource(sourceId, sourceTitle) {
            if (!confirm(`Are you sure you want to delete "${sourceTitle}"?`)) {
                return;
            }
            
            const sourceCard = document.getElementById(`source-${sourceId}`);
            if (sourceCard) {
                sourceCard.style.opacity = '0.5';
                sourceCard.style.pointerEvents = 'none';
            }
            
            try {
                const response = await fetch(`${API_BASE}/sources/${sourceId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Delete failed: ${response.status}`);
                }
                
                if (sourceCard) {
                    sourceCard.remove();
                }
                
                const sourcesList = document.getElementById('sources-list');
                if (sourcesList.children.length === 0) {
                    sourcesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìö</div>
                            <div class="empty-title">No sources yet</div>
                            <div class="empty-description">Upload your first source to get started</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                if (sourceCard) {
                    sourceCard.style.opacity = '1';
                    sourceCard.style.pointerEvents = 'auto';
                }
            }
        }
        
        async function loadSourcesFromBackend() {
            const sourcesList = document.getElementById('sources-list');
            
            try {
                const response = await fetch(`${API_BASE}/sources`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const sources = await response.json();
                sourcesList.innerHTML = '';
                
                if (sources.length === 0) {
                    sourcesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìö</div>
                            <div class="empty-title">No sources yet</div>
                            <div class="empty-description">Upload your first source to get started</div>
                        </div>
                    `;
                } else {
                    sources.forEach(source => {
                        addSourceToUI({
                            id: source.id,
                            title: source.title,
                            author: source.author,
                            source_type: source.source_type,
                            status: 'completed',
                            chunks_created: source.chunk_count
                        });
                    });
                }
                
            } catch (error) {
                console.error('Error loading sources:', error);
                sourcesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Connection Error</div>
                        <div class="empty-description">Could not load sources. Is your backend running?</div>
                    </div>
                `;
            }
        }
        
        function addSourceToUI(source) {
            const sourcesList = document.getElementById('sources-list');
            
            const emptyState = sourcesList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const sourceCard = document.createElement('div');
            sourceCard.className = 'source-card';
            sourceCard.id = `source-${source.id}`;
            
            const statusBadge = getStatusBadge(source.status, source);
            const icon = getSourceIcon(source.source_type);
            
            sourceCard.innerHTML = `
                <div class="source-header">
                    <div class="source-icon">${icon}</div>
                    <div class="source-info">
                        <div class="source-title">${source.title}</div>
                        <div class="source-author">${source.author}</div>
                    </div>
                    ${statusBadge}
                </div>
                <div class="source-actions" style="display: ${source.status === 'processing' ? 'none' : 'flex'};">
                    <button class="source-action-btn" onclick="alert('View notes for: ${source.title}')">Notes</button>
                    <button class="source-action-btn" onclick="alert('Details for: ${source.title}')">Details</button>
                    <button class="source-action-btn delete" onclick="deleteSource('${source.id}', '${source.title}')">Delete</button>
                </div>
            `;

            sourcesList.insertBefore(sourceCard, sourcesList.firstChild);
        }
        
        function updateSourceStatus(tempId, updateData) {
            const sourceCard = document.getElementById(`source-${tempId}`);
            if (!sourceCard) return;
            
            if (updateData.id && updateData.id !== tempId) {
                sourceCard.id = `source-${updateData.id}`;
            }
            
            if (updateData.status) {
                const statusBadge = getStatusBadge(updateData.status, updateData);
                const existingBadge = sourceCard.querySelector('.status-badge');
                if (existingBadge) {
                    existingBadge.outerHTML = statusBadge;
                }
            }
            
            const actionsDiv = sourceCard.querySelector('.source-actions');
            if (actionsDiv && updateData.status) {
                actionsDiv.style.display = updateData.status === 'completed' ? 'flex' : 'none';
            }
        }
        
        function getStatusBadge(status, data = {}) {
            let badgeClass = 'status-badge';
            let badgeText = '';
            
            switch (status) {
                case 'processing':
                    badgeClass += ' processing';
                    badgeText = 'Processing...';
                    break;
                case 'completed':
                    badgeText = `${data.chunks_created || 0} chunks`;
                    break;
                case 'error':
                    badgeClass += ' error';
                    badgeText = 'Error';
                    break;
                default:
                    return '';
            }
            
            return `<div class="${badgeClass}">${badgeText}</div>`;
        }
        
        function getSourceIcon(sourceType) {
            switch (sourceType) {
                case 'txt': return 'üìÑ';
                case 'json': return 'üß†';
                case 'pdf': return 'üìï';
                default: return 'üìÑ';
            }
        }
        
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const dropArea = document.querySelector('.file-drop-area');
            const editor = document.getElementById('document-editor');
            
            // File input handling
            if (fileInput && dropArea) {
                fileInput.addEventListener('change', function(e) {
                    handleFileSelection(e.target.files[0]);
                });
                
                dropArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropArea.classList.add('dragover');
                });
                
                dropArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    dropArea.classList.remove('dragover');
                });
                
                dropArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropArea.classList.remove('dragover');
                    handleFileSelection(e.dataTransfer.files[0]);
                });
            }
            
            // Editor cursor/selection change handling
            if (editor) {
                editor.addEventListener('click', updateNotesBasedOnContext);
                editor.addEventListener('keyup', updateNotesBasedOnContext);
                editor.addEventListener('selectionchange', updateNotesBasedOnContext);
                
                // Initial context update
                setTimeout(updateNotesBasedOnContext, 1000);
            }
            
            console.log('Research Assistant loaded successfully');
        });
        
        // Make functions globally accessible
        window.switchToPanel = switchToPanel;
        window.showUploadInterface = showUploadInterface;
        window.hideUploadInterface = hideUploadInterface;
        window.processUpload = processUpload;
        window.deleteSource = deleteSource;
    </script>
</body>
</html>
